name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: false
        default: ''

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v$(date +'%Y%m%d%H%M%S')"
          fi
          CLEAN_VERSION=$(echo $VERSION | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          npm version ${{ steps.version.outputs.clean_version }} --no-git-tag-version --allow-same-version

      - name: Install WebUI dependencies
        run: cd src/webui && pnpm install

      - name: Build project
        run: pnpm run build

      - name: Prepare release package
        env:
          PLUGIN_NAME: napcat-plugin-template
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºç»„ç»‡æ–‡ä»¶
          mkdir -p release

          # å¤åˆ¶éœ€è¦çš„æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          cp dist/index.mjs release/
          cp dist/package.json release/
          cp -r dist/webui release/

          # è¿›å…¥ä¸´æ—¶ç›®å½•å¹¶å‹ç¼©
          cd release
          zip -r ../${PLUGIN_NAME}.zip index.mjs package.json webui

      - name: Verify zip contents
        run: |
          PLUGIN_NAME="napcat-plugin-template"
          unzip -l ${PLUGIN_NAME}.zip

      - name: Collect git log
        id: gitlog
        run: |
          CURRENT_TAG="${{ steps.version.outputs.version }}"

          # è·å–ä¸Šä¸€ä¸ª tag
          git fetch --tags --force
          PREV_TAG=$(git tag -l "v*" --sort=version:refname | grep -v "$CURRENT_TAG" | tail -1)

          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD | head -1)
          fi

          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREV_TAG"

          COMMITS=$(git log --pretty=format:'- %s (%h)' "$PREV_TAG"..HEAD 2>/dev/null || git log --pretty=format:'- %s (%h)' -10)

          # å†™å…¥æ–‡ä»¶ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "$COMMITS" > commits.txt

          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      # ï¼ˆå¯é€‰ï¼‰AI ç”Ÿæˆ Release Note
      # å¦‚éœ€å¯ç”¨ï¼Œè¯·åœ¨ä»“åº“ Settings > Secrets and variables > Actions > Repository secrets ä¸­é…ç½®ï¼š
      #   AI_API_URL: å…¼å®¹ OpenAI æ ¼å¼çš„ API åœ°å€ï¼ˆå¦‚ https://api.openai.com/v1/chat/completionsï¼‰
      #   AI_API_KEY: å¯¹åº”çš„ API å¯†é’¥
      #   AI_MODEL:  ï¼ˆå¯é€‰ï¼‰æ¨¡å‹åç§°ï¼Œé»˜è®¤ gpt-4o-mini
      - name: Check AI config
        id: ai_check
        run: |
          if [ -n "$AI_API_KEY" ] && [ -n "$AI_API_URL" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ° AI é…ç½®ï¼Œå°†ä½¿ç”¨ AI ç”Ÿæˆ Release Note"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æœªé…ç½® AI_API_KEY / AI_API_URLï¼Œå°†ä½¿ç”¨é»˜è®¤ Release Note"
          fi
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_API_URL: ${{ secrets.AI_API_URL }}

      - name: AI Generate Release Note
        id: ai_release
        if: steps.ai_check.outputs.available == 'true'
        continue-on-error: true
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_API_URL: ${{ secrets.AI_API_URL }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
        run: |
          CURRENT_TAG="${{ steps.gitlog.outputs.current_tag }}"
          PREV_TAG="${{ steps.gitlog.outputs.prev_tag }}"
          COMMITS=$(cat commits.txt)
          MODEL="${AI_MODEL:-gpt-4o-mini}"

          echo "ğŸ¤– ä½¿ç”¨ AI ç”Ÿæˆ Release Note (model: $MODEL)"

          # è·å–æ–‡ä»¶å˜æ›´ç»Ÿè®¡å’Œä»£ç  diff
          SUMMARY_LINE=$(git diff --stat "$PREV_TAG"..HEAD | tail -1 || echo "No changes")
          FILE_CHANGES=$(git diff --stat "$PREV_TAG"..HEAD | head -n -1 | head -30 || echo "")
          CODE_DIFF=$(git diff "$PREV_TAG"..HEAD -- 'src/*.ts' | head -c 5000 || echo "Diff too large or no code changes")

          # è¯»å–è‡ªå®šä¹‰ prompt æ¨¡æ¿ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          SYSTEM_PROMPT="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¼€å‘è€…åŠ©æ‰‹ï¼Œè¯·æ ¹æ®ä»¥ä¸‹ git commit è®°å½•ï¼Œç”Ÿæˆç®€æ´ç¾è§‚çš„ä¸­æ–‡ Release Noteã€‚è¦æ±‚ï¼š1) ä½¿ç”¨ Markdown æ ¼å¼ 2) æŒ‰åŠŸèƒ½åˆ†ç±»ï¼ˆå¦‚æ–°åŠŸèƒ½ã€ä¿®å¤ã€ä¼˜åŒ–ç­‰ï¼‰3) è¯­è¨€ç®€æ´ 4) ç‰ˆæœ¬å·ä¸º ${CURRENT_TAG}"

          if [ -f ".github/prompt/release_note_prompt.txt" ]; then
            SYSTEM_PROMPT=$(cat .github/prompt/release_note_prompt.txt)
          fi

          USER_CONTENT="å½“å‰ç‰ˆæœ¬: $CURRENT_TAG
          ä¸Šä¸€ç‰ˆæœ¬: $PREV_TAG
          æ—¥æœŸ: $(date +'%Y-%m-%d')

          ## æäº¤åˆ—è¡¨
          $COMMITS

          ## æ–‡ä»¶å˜åŒ–ç»Ÿè®¡
          $SUMMARY_LINE

          ## å˜æ›´æ–‡ä»¶åˆ—è¡¨
          $FILE_CHANGES

          ## å…³é”®ä»£ç å˜åŒ–é¢„è§ˆ
          \`\`\`diff
          $CODE_DIFF
          \`\`\`"

          # æ„é€ è¯·æ±‚ JSON
          PAYLOAD=$(jq -n \
            --arg model "$MODEL" \
            --arg system "$SYSTEM_PROMPT" \
            --arg user "$USER_CONTENT" \
            '{
              model: $model,
              messages: [
                { role: "system", content: $system },
                { role: "user", content: $user }
              ],
              temperature: 0.2,
              max_tokens: 1500
            }')

          # è°ƒç”¨ API
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            --max-time 60 \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $AI_API_KEY" \
            -d "$PAYLOAD" \
            "$AI_API_URL")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            # æå– AI è¿”å›å†…å®¹
            AI_CONTENT=$(echo "$BODY" | jq -r '.choices[0].message.content // empty')
            if [ -n "$AI_CONTENT" ]; then
              echo -e "$AI_CONTENT" > CHANGELOG.md
              # æ›¿æ¢å ä½ç¬¦
              sed -i "s/{VERSION}/$CURRENT_TAG/g" CHANGELOG.md
              sed -i "s/{PREV_VERSION}/$PREV_TAG/g" CHANGELOG.md
              echo "ai_success=true" >> $GITHUB_OUTPUT
              echo "âœ… AI Release Note ç”ŸæˆæˆåŠŸ"
            else
              echo "âš ï¸ AI è¿”å›å†…å®¹ä¸ºç©ºï¼Œå°†ä½¿ç”¨é»˜è®¤ Release Note"
              echo "ai_success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ AI API è¯·æ±‚å¤±è´¥ (HTTP $HTTP_CODE)ï¼Œå°†ä½¿ç”¨é»˜è®¤ Release Note"
            echo "Response: $BODY"
            echo "ai_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Fallback Release Note
        if: steps.ai_release.outputs.ai_success != 'true'
        run: |
          CURRENT_TAG="${{ steps.gitlog.outputs.current_tag }}"
          COMMITS=$(cat commits.txt)

          if [ -f ".github/prompt/default.md" ]; then
            sed "s/{VERSION}/$CURRENT_TAG/g" .github/prompt/default.md > CHANGELOG.md
          else
            echo "## $CURRENT_TAG" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "### æ›´æ–°å†…å®¹" >> CHANGELOG.md
            echo "$COMMITS" >> CHANGELOG.md
          fi
          echo "ğŸ“ ä½¿ç”¨é»˜è®¤ Release Note"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          files: |
            napcat-plugin-template.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # è§¦å‘ç´¢å¼•æ›´æ–°å·¥ä½œæµ
      # æ³¨æ„ï¼šé»˜è®¤ GITHUB_TOKEN åˆ›å»ºçš„ Release ä¸ä¼šè§¦å‘ on.release äº‹ä»¶
      # å› æ­¤éœ€è¦æ‰‹åŠ¨é€šè¿‡ workflow_dispatch è§¦å‘ update-index.yml
      - name: Trigger index update
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'update-index.yml',
              ref: 'main',
              inputs: {
                version: '${{ steps.version.outputs.version }}'
              }
            })
            console.log('âœ… å·²è§¦å‘ update-index.yml å·¥ä½œæµ')
