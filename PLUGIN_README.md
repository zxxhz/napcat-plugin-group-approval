# 加群申请审批插件

这是一个 NapCat 插件，支持根据不同的群设置不同的正则表达式来自动审批或拒绝加群申请。

## 功能特性

- ✅ **自动审批**：根据正则表达式自动处理群入申请
- ✅ **按群配置**：每个群可设置独立的审批规则
- ✅ **灵活匹配**：支持正则表达式匹配申请理由
- ✅ **通过所有**：支持直接通过该群的所有申请
- ✅ **自定义拒绝理由**：支持群级别和全局拒绝理由
- ✅ **正则表达式测试**：WebUI 中可测试正则表达是否符合预期
- ✅ **调试模式**：开启后输出详细日志便于排查问题

## 安装

1. 将插件放在 NapCat 的 `plugins` 目录中
2. 重启 NapCat 或重载插件
3. 在 NapCat WebUI 中打开插件配置面板

## 配置说明

### 全局配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | 布尔值 | `true` | 是否启用自动审批功能 |
| `debug` | 布尔值 | `false` | 启用调试模式，输出详细日志 |
| `autoApproveEnabled` | 布尔值 | `true` | 启用自动审批处理 |
| `rejectWithReason` | 布尔值 | `true` | 拒绝申请时是否告知理由 |
| `rejectReason` | 字符串 | `不符合入群要求` | 全局拒绝理由 |

### 群配置

每个群可独立配置以下项目：

| 配置项 | 类型 | 说明 |
|--------|------|------|
| `enabled` | 布尔值 | 是否启用此群的自动审批功能 |
| `pattern` | 字符串 | 正则表达式，申请理由必须匹配才能通过 |
| `approveAll` | 布尔值 | 若为 `true`，则通过该群的所有申请 |
| `customRejectReason` | 字符串 | 拒绝申请时的原因（覆盖全局设置） |

## 使用示例

### 示例 1：简单的关键词匹配

要求申请理由中必须包含 "进群" 或 "加群"：

```
群 ID: 123456789
正则表达式: (进群|加群)
```

### 示例 2：更严格的格式要求

要求申请理由必须包含群号或特定的口令：

```
群 ID: 987654321
正则表达式: .*87654321.*
（或）
正则表达式: ^(password|口令)$
```

### 示例 3：不拒绝任何申请

通过该群的所有申请：

```
群 ID: 111111111
approveAll: true
```

### 示例 4：自定义拒绝理由

```
群 ID: 222222222
pattern: ^(hello|hi)$
customRejectReason: 申请理由不符合要求，请提供有效的暗语
```

## 正则表达式速查表

### 常用表达式

| 需求 | 正则表达式 | 说明 |
|------|-----------|------|
| 包含某个关键词 | `关键词` | 申请理由中包含 "关键词" |
| 包含多个关键词之一 | `(词1\|词2\|词3)` | 包含 词1、词2 或 词3 |
| 不区分大小写 | 使用 `(?i)` 前缀 | 如 `(?i)hello` 匹配 hello、Hello、HELLO |
| 精确匹配 | `^内容$` | 申请理由必须完全等于 "内容" |
| 以某字开头 | `^某字` | 申请理由必须以 "某字" 开头 |
| 以某字结尾 | `某字$` | 申请理由必须以 "某字" 结尾 |
| 任意字符 | `.` | 匹配任意单个字符 |
| 重复 0 次或多次 | `*` | 如 `a*` 匹配 "" "a" "aa" 等 |
| 重复 1 次或多次 | `+` | 如 `a+` 匹配 "a" "aa" 等 |
| 可选 | `?` | 如 `colou?r` 匹配 "color" 或 "colour" |

### 测试工具

在 WebUI 的配置页面中，有"测试正则表达式"功能：

1. 输入你的正则表达式
2. 输入测试字符串（模拟申请理由）
3. 查看是否匹配

## API 端点

### 1. 获取插件状态

```
GET /api/Plugin/ext/{plugin-id}/status
```

返回插件运行状态、配置等信息。

### 2. 获取/更新配置

```
GET /plugin/{plugin-id}/api/config
POST /plugin/{plugin-id}/api/config
```

获取或更新全局配置。

### 3. 获取群列表

```
GET /plugin/{plugin-id}/api/groups
```

获取机器人所在的所有群及其配置状态。

### 4. 获取/更新群配置

```
GET /plugin/{plugin-id}/api/groups/{group-id}/config
POST /plugin/{plugin-id}/api/groups/{group-id}/config
```

获取或更新某个群的配置（包括正则表达式、启用状态等）。

### 5. 测试正则表达式

```
POST /plugin/{plugin-id}/api/test-pattern
```

请求体：
```json
{
    "pattern": "(?i)hello",
    "testString": "Hello World"
}
```

返回：
```json
{
    "code": 0,
    "data": {
        "matches": true,
        "pattern": "(?i)hello",
        "testString": "Hello World"
    }
}
```

## 日志示例

启用调试模式后，你会看到类似的日志输出：

```
[插件] (｡-ω-) 收到加群申请: 群=123456789, 用户=654321, 申请理由="请允许我加群"
[插件] 正则匹配结果: 群=123456789, 正则=加群, 理由="请允许我加群", 匹配=true
[插件] (≧▽≦) 已通过加群申请: 群=123456789, 用户=654321, 理由="请允许我加群"
```

或者

```
[插件] (；′⌒`) 已拒绝加群申请: 群=987654321, 用户=654321, 理由="不符合要求"
```

## 常见问题

### Q: 为什么我的申请没有被自动处理？

**A:** 检查以下几点：

1. 确认全局 `enabled` 和 `autoApproveEnabled` 都是 `true`
2. 确认该群 `enabled` 不是 `false`
3. 开启调试模式，查看日志输出
4. 使用"测试正则表达式"功能验证你的正则是否正确
5. 确认 NapCat 正在运行且机器人已登录

### Q: 如何禁用某个群的自动审批？

**A:** 在该群的配置中将 `enabled` 设置为 `false`，或不设置任何规则（默认拒绝）。

### Q: 拒绝申请时能否不显示理由？

**A:** 将全局配置的 `rejectWithReason` 设置为 `false`。

### Q: 支持哪些正则表达式语法？

**A:** 使用 JavaScript 正则表达式语法。大部分常见的正则表达式都支持：

- 字符类：`[abc]` `[a-z]` `\d` `\s` `\w` 等
- 量词：`*` `+` `?` `{n,m}` 等
- 分组：`()` 等
- 和、或：`|`
- 锚点：`^` `$`
- 后向引用、环视等高级用法

### Q: 如何完全通过某个群的所有申请？

**A:** 将该群的 `approveAll` 设置为 `true`。

## 开发

```bash
# 安装依赖
pnpm install

# 类型检查
pnpm run typecheck

# 构建
pnpm run build

# 开发模式（文件变化时自动重构建）
pnpm run dev

# 推送到远程并热重载
pnpm run push

# 前端开发服务器
pnpm run dev:webui
```

## 许可证

MIT
